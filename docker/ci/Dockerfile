FROM ruby:2.7.1-buster
MAINTAINER operations@openproject.com

ENV USER=dev
RUN useradd -d /home/$USER -m $USER
WORKDIR /home/$USER

RUN wget --quiet -O- https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -
RUN echo "deb http://apt.postgresql.org/pub/repos/apt buster-pgdg main" > /etc/apt/sources.list.d/pgdg.list

RUN apt-get update -qq && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
    postgresql-9.6 postgresql-client-9.6 time pandoc default-jre-headless

ENV CI=true
ENV RAILS_ENV=test
ENV NODE_VERSION="12.18.3"
ENV BUNDLER_VERSION="2.1.4"
ENV BUNDLE_WITHOUT="development:production:docker"
ENV DATABASE_URL=postgres://app:p4ssw0rd@127.0.0.1/app
ENV CHROME_SOURCE_URL=https://dl.google.com/dl/linux/direct/google-chrome-stable_current_amd64.deb
ENV JOBS=4

RUN wget --no-verbose -O /tmp/$(basename $CHROME_SOURCE_URL) $CHROME_SOURCE_URL && \
  apt install -y /tmp/$(basename $CHROME_SOURCE_URL) && rm -f /tmp/$(basename $CHROME_SOURCE_URL)

RUN curl -s https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-x64.tar.gz | tar xzf - -C /usr/local --strip-components=1
RUN gem install bundler --version "$BUNDLER_VERSION" --no-document

COPY ./entrypoint.sh /usr/sbin/entrypoint.sh

VOLUME [ "/usr/local/bundle", "/home/$USER/openproject", "/home/$USER/openproject/tmp" ]

WORKDIR /home/$USER/openproject

ENTRYPOINT [ "/usr/sbin/entrypoint.sh" ]

EXPOSE 3000
EXPOSE 3001
EXPOSE 3002
EXPOSE 3003
EXPOSE 3004
EXPOSE 3005
EXPOSE 3006
EXPOSE 3007
EXPOSE 3008
EXPOSE 3009
EXPOSE 3010
EXPOSE 3011
EXPOSE 3012
EXPOSE 3013
EXPOSE 3014
EXPOSE 3015
EXPOSE 3016
